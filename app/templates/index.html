<!DOCTYPE html>
<html lang="{{ 'en' if lang == 'en' else 'pt-br' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{{ t.get('description', 'Controle financeiro pessoal inteligente') }}">
    <meta name="theme-color" content="#3B82F6">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>{{ t.get('app_name', 'FinanceTracker') }}</title>
    
    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="FinanceTracker">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind + DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- AOS Animations -->
    <!-- <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script> -->
    
    <script>
        // Configura Tailwind
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <script>
        // Aplica tema antes de renderizar para evitar flash
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');
            
            document.documentElement.classList.toggle('dark', theme === 'dark');
            document.documentElement.setAttribute('data-theme', theme);
            
            if (!savedTheme) {
                localStorage.setItem('theme', theme);
            }
        })();
    </script>
    
    <style>
        @media (prefers-color-scheme: dark) {
            .dark { color-scheme: dark; }
        }
        
        /* Smooth transitions */
        * {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        
        /* Fade in suave ao carregar */
        body {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #CBD5E1;
            border-radius: 4px;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }
        
        /* Glassmorphism effect */
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark .glass {
            background: rgba(31, 41, 55, 0.9);
            border: 1px solid rgba(75, 85, 99, 0.2);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 font-sans antialiased">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="w-64 bg-white dark:bg-gray-800 shadow-2xl flex flex-col border-r border-gray-200 dark:border-gray-700 transition-transform duration-300 ease-in-out lg:translate-x-0 -translate-x-full fixed lg:relative z-40 h-full">
            <!-- Logo/Header -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-indigo-600 to-purple-600">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-white">{{ t.get('app_name', 'FinanceTracker') }}</h1>
                        <p class="text-xs text-blue-100">{{ t.get('subtitle', 'Controle Financeiro') }}</p>
                    </div>
                </div>
            </div>
            
            <!-- Navigation -->
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <a href="/" class="flex items-center gap-3 px-4 py-3 text-white bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl font-medium shadow-lg transform hover:scale-105 transition-all duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    {{ t.get('dashboard', 'Dashboard') }}
                </a>
                
                <button onclick="document.getElementById('modalAddGasto').classList.remove('hidden')" 
                        class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl font-medium transition-all duration-200 hover:translate-x-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    {{ t.get('new_expense', 'Novo Gasto') }}
                </button>
                
                <button onclick="document.getElementById('modalImportarExtrato').classList.remove('hidden')" 
                        class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl font-medium transition-all duration-200 hover:translate-x-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    {{ t.get('import_statement', 'Importar Extrato') }}
                </button>
                
                <a href="/exportar?mes={{ mes_ref }}" 
                   class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl font-medium transition-all duration-200 hover:translate-x-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    {{ t.get('export_data', 'Exportar Dados') }}
                </a>
                
                <div class="pt-4 mt-4 border-t border-gray-200 dark:border-gray-700">
                    <p class="px-4 text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2">{{ t.get('settings', 'Configurações') }}</p>
                    
                    <button onclick="document.getElementById('modalOrcamento').classList.remove('hidden')" 
                            class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl font-medium transition-all duration-200 hover:translate-x-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                        </svg>
                        {{ t.get('budget', 'Orçamento') }}
                    </button>
                    
                    <button onclick="document.getElementById('modalCiclo').classList.remove('hidden')" 
                            class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl font-medium transition-all duration-200 hover:translate-x-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        {{ t.get('billing_cycle', 'Ciclo de Fatura') }}
                    </button>
                    
                    <button onclick="document.getElementById('modalRegras').classList.remove('hidden'); carregarRegras();" 
                            class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl font-medium transition-all duration-200 hover:translate-x-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                        </svg>
                        {{ t.get('categorization_rules', 'Regras de Categorização') }}
                    </button>
                </div>
            </nav>
            
            <!-- Controles de Tema e Idioma -->
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 space-y-3">
                <button onclick="toggleTheme()" 
                        class="w-full flex items-center gap-3 px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition">
                    <svg id="themeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                    </svg>
                    <span id="themeText">{{ t.get('dark_mode', 'Modo Escuro') }}</span>
                </button>
                
                <div class="flex gap-2">
                    <a href="#" onclick="changeLanguage('pt'); return false;" 
                       class="flex-1 text-center px-3 py-2 text-sm {{ 'bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300' if lang != 'en' else 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400' }} rounded-lg font-medium transition">
                        PT
                    </a>
                    <a href="#" onclick="changeLanguage('en'); return false;" 
                       class="flex-1 text-center px-3 py-2 text-sm {{ 'bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300' if lang == 'en' else 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400' }} rounded-lg font-medium transition">
                        EN
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Overlay para mobile -->
        <div id="sidebarOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden" onclick="toggleSidebar()"></div>
        
        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top Bar -->
            <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <!-- Botão toggle sidebar (apenas mobile) -->
                        <button onclick="toggleSidebar()" class="lg:hidden p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">
                            <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                        </button>
                        <div>
                            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 dark:text-white">{{ t.get('financial_dashboard', 'Dashboard Financeiro') }}</h2>
                            <div class="flex items-center gap-2 sm:gap-4 mt-1">
                                <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400">{{ t.get('period', 'Período') }}:</p>
                                <select onchange="window.location.href='/?mes='+this.value" 
                                        class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 text-xs sm:text-sm rounded-lg px-2 sm:px-3 py-1.5 font-medium cursor-pointer focus:ring-2 focus:ring-indigo-500">
                                    {% for mes in meses_disponiveis %}
                                    <option value="{{ mes }}" {% if mes == mes_ref %}selected{% endif %}>
                                        {{ mes.split('-')[1] }}/{{ mes.split('-')[0] }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right hidden sm:block">
                            <p class="text-sm text-gray-500 dark:text-gray-400">{{ t.get('month_total', 'Total do Mês') }}</p>
                            <p class="text-xl font-bold text-gray-800 dark:text-white">R$ {{ total_mes | moeda }}</p>
                        </div>
                        <!-- User menu -->
                        <div class="flex items-center gap-3 pl-4 border-l border-gray-200 dark:border-gray-700">
                            <div class="flex flex-col items-center gap-1">
                                <button onclick="document.getElementById('modalPerfil').classList.remove('hidden')" class="w-10 h-10 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-full flex items-center justify-center hover:shadow-lg transition">
                                    <span class="text-white text-sm font-medium">{{ usuario.nome[0].upper() }}</span>
                                </button>
                                <p class="text-xs font-medium text-gray-800 dark:text-white hidden md:block">{{ usuario.nome }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="flex-1 overflow-auto p-3 sm:p-6 space-y-4 sm:space-y-6 bg-gray-100 dark:bg-gray-900">
            
            <!-- Alerta para mês anterior -->
            {% if mes_ref != mes_atual %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                    </svg>
                    <div>
                        <p class="font-medium text-yellow-800">Visualizando mês anterior</p>
                        <p class="text-sm text-yellow-700">Você está vendo dados de {{ mes_ref.split('-')[1] }}/{{ mes_ref.split('-')[0] }}. Gastos adicionados aqui serão registrados neste período.</p>
                    </div>
                </div>
            </div>
            {% endif %}
            
                <!-- Cards Principais -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6">
                <div class="glass rounded-xl sm:rounded-2xl shadow-xl p-3 sm:p-6 hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300">
                    <div class="flex items-center justify-between mb-2 sm:mb-3">
                        <h3 class="text-[10px] sm:text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">{{ t.get('total_month', 'Total do Mês') }}</h3>
                        <div class="w-8 h-8 sm:w-10 sm:h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg sm:rounded-xl flex items-center justify-center">
                            <svg class="w-4 h-4 sm:w-5 sm:h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-lg sm:text-xl lg:text-3xl font-extrabold text-gray-900 dark:text-white mb-2 sm:mb-3 tracking-tight break-words">R$ {{ total_mes | moeda }}</p>
                    {% if meta_mensal > 0 %}
                    <div class="space-y-2">
                        <div class="flex justify-between text-[10px] sm:text-xs text-gray-600 dark:text-gray-400 font-medium">
                            <span class="truncate">{{ t.get('goal', 'Meta') }}: R$ {{ meta_mensal | moeda }}</span>
                            <span class="font-bold ml-2">{{ (total_mes/meta_mensal*100)|round|int }}%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 overflow-hidden">
                            <div class="h-full rounded-full transition-all duration-500 {% if total_mes > meta_mensal %}bg-gradient-to-r from-red-500 to-red-600{% else %}bg-gradient-to-r from-blue-500 to-blue-600{% endif %}" 
                                 style="width: {{ [100, (total_mes/meta_mensal*100)|round|int]|min }}%"></div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="glass rounded-xl sm:rounded-2xl shadow-xl p-3 sm:p-6 hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300">
                    <div class="flex items-center justify-between mb-2 sm:mb-3">
                        <h3 class="text-[10px] sm:text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">{{ t.get('monthly_variation', 'Variação Mensal') }}</h3>
                        <div class="w-8 h-8 sm:w-10 sm:h-10 {% if variacao > 0 %}bg-red-100 dark:bg-red-900/30{% else %}bg-green-100 dark:bg-green-900/30{% endif %} rounded-lg sm:rounded-xl flex items-center justify-center">
                            <svg class="w-4 h-4 sm:w-5 sm:h-5 {% if variacao > 0 %}text-red-600 dark:text-red-400{% else %}text-green-600 dark:text-green-400{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="{% if variacao > 0 %}M13 17h8m0 0V9m0 8l-8-8-4 4-6-6{% else %}M13 7h8m0 0v8m0-8l-8 8-4-4-6 6{% endif %}"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-lg sm:text-xl lg:text-3xl font-extrabold {% if variacao > 0 %}text-red-500{% else %}text-green-500{% endif %} mb-1 tracking-tight break-words">
                        {% if variacao > 0 %}+{% endif %}{{ "%.1f"|format(variacao) }}%
                    </p>
                    <p class="text-[10px] sm:text-xs text-gray-500 dark:text-gray-400 font-medium truncate">{{ t.get('previous_month', 'Mês anterior') }}: R$ {{ total_mes_anterior | moeda }}</p>
                </div>

                <div class="glass rounded-2xl shadow-xl p-6 hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300" data-aos="fade-up" data-aos-delay="200">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">{{ t.get('forecast', 'Previsão') }}</h3>
                        <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-3xl font-extrabold text-gray-900 dark:text-white mb-1 tracking-tight">R$ {{ previsao | moeda }}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 font-medium">{{ t.get('average_last_3_months', 'Média últimos 3 meses') }}</p>
                </div>

                <div class="glass rounded-2xl shadow-xl p-6 hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300" data-aos="fade-up" data-aos-delay="300">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">{{ t.get('closing', 'Fechamento') }}</h3>
                        <div class="w-10 h-10 bg-orange-100 dark:bg-orange-900/30 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                    </div>
                    <p class="text-3xl font-extrabold text-gray-900 dark:text-white mb-1 tracking-tight">{{ t.get('day', 'Dia') }} {{ dia_fechamento }}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 font-medium">{{ t.get('due_date', 'Data de vencimento') }}</p>
                </div>
            </div>

            <!-- Gráficos -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
                
                <!-- Gráfico Evolução -->
                <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm p-3 sm:p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4">
                        <h2 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white">{{ t.get('expense_evolution', 'Evolução dos Gastos') }}</h2>
                        <select id="periodoFiltro" onchange="filtrarPeriodo(this.value)" 
                                class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 text-xs rounded-lg px-3 py-1.5 font-medium cursor-pointer focus:ring-2 focus:ring-blue-500">
                            <option value="1">{{ t.get('1_month', '1 Mês') }}</option>
                            <option value="3">{{ t.get('3_months', '3 Meses') }}</option>
                            <option value="6">{{ t.get('6_months', '6 Meses') }}</option>
                            <option value="12" selected>{{ t.get('12_months', '12 Meses') }}</option>
                        </select>
                    </div>
                    <div class="h-48 sm:h-72">
                        <canvas id="evolucaoChart"></canvas>
                    </div>
                </div>

                <!-- Gráfico Pizza -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-3 sm:p-6">
                    <h2 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-4">{{ t.get('distribution_by_category', 'Distribuição por Categoria') }}</h2>
                    <div class="h-48 sm:h-72">
                        <canvas id="gastosChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Top 5 e Resumo -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                
                <!-- Top 5 Maiores Gastos -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-3 sm:p-6">
                    <h2 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-4">{{ t.get('top_expenses', 'Maiores Gastos do Mês') }}</h2>
                    <div class="space-y-3">
                        {% for gasto in top5_gastos %}
                        <div class="flex items-center justify-between p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-gray-900 dark:text-white truncate">{{ gasto.estabelecimento }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ gasto.data_compra.strftime('%d/%m/%Y às %H:%M') }}</p>
                            </div>
                            <span class="font-bold text-gray-900 dark:text-white ml-3">R$ {{ gasto.valor | moeda }}</span>
                        </div>
                        {% else %}
                        <p class="text-center text-gray-400 dark:text-gray-500 py-8">{{ t.get('no_expenses', 'Nenhum gasto registrado') }}</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Resumo por Categoria -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-3 sm:p-6">
                    <h2 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-4">{{ t.get('category_summary', 'Resumo por Categoria') }}</h2>
                    <div class="space-y-3">
                        {% for categoria, dados in categorias[:5] %}
                        <div class="flex items-center justify-between p-3 border border-gray-200 dark:border-gray-700 rounded-lg">
                            <div class="flex-1">
                                <p class="font-medium text-gray-900 dark:text-white text-sm">{{ categoria }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ dados.quantidade }} {{ t.get('transactions', 'transações') }}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-gray-900 dark:text-white text-sm">R$ {{ dados.total | moeda }}</p>
                                <p class="text-xs text-blue-600 dark:text-blue-400 font-medium">{{ "%.0f"|format((dados.total / total_mes * 100) if total_mes > 0 else 0) }}%</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Extrato -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden">
                <div class="px-3 sm:px-6 py-3 sm:py-4 border-b border-gray-200 dark:border-gray-700 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                    <h2 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white">{{ t.get('full_statement', 'Extrato Completo') }}</h2>
                    <div class="relative w-full sm:w-auto">
                        <input type="text" id="searchInput" placeholder="{{ t.get('search_transaction', 'Buscar transação...') }}" 
                               class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-64">
                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full" id="extratoTable">
                        <thead class="bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                            <tr class="text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                <th class="px-6 py-3 text-left">{{ t.get('date', 'Data') }}</th>
                                <th class="px-6 py-3 text-left">{{ t.get('establishment', 'Estabelecimento') }}</th>
                                <th class="px-6 py-3 text-left">{{ t.get('category', 'Categoria') }}</th>
                                <th class="px-6 py-3 text-right">{{ t.get('value', 'Valor') }}</th>
                                <th class="px-6 py-3 text-center">{{ t.get('actions', 'Ações') }}</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                            {% for gasto in gastos %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-300 font-mono whitespace-nowrap">{{ gasto.data_compra.strftime('%d/%m %H:%M') }}</td>
                                <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white">{{ gasto.estabelecimento }}</td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
                                        {{ gasto.categoria }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm font-semibold text-gray-900 dark:text-white text-right whitespace-nowrap">R$ {{ gasto.valor | moeda }}</td>
                                <td class="px-6 py-4 text-center">
                                    <button onclick="editarGasto({{ gasto.id }}, '{{ gasto.estabelecimento }}', '{{ gasto.categoria }}', {{ gasto.valor }}, '{{ gasto.data_compra.strftime('%Y-%m-%d') }}')" 
                                            class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 mr-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                    </button>
                                    <button onclick="excluirGasto({{ gasto.id }})" 
                                            class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" class="px-6 py-12 text-center text-gray-400 dark:text-gray-500">{{ t.get('no_expenses_month', 'Nenhum gasto registrado neste mês') }}</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            </main>
        </div>
    </div>

    <!-- Modal Add Gasto -->
    <div id="modalAddGasto" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white dark:bg-gray-800 px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg sm:text-xl font-semibold text-gray-900 dark:text-white">Adicionar Gasto</h3>
                    <button onclick="document.getElementById('modalAddGasto').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <form method="POST" action="/adicionar-gasto" class="p-4 sm:p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data do Gasto</label>
                    <input type="date" name="data_gasto" required 
                           class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg px-3 sm:px-4 py-2.5 text-sm sm:text-base focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Valor (R$)</label>
                    <input type="number" name="valor" step="0.01" required placeholder="0.00"
                           class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Estabelecimento</label>
                    <input type="text" name="estabelecimento" required placeholder="Ex: Supermercado"
                           class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Categoria</label>
                    <select name="categoria" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="Alimentação">Alimentação</option>
                        <option value="Transporte">Transporte</option>
                        <option value="Lazer/Assinaturas">Lazer/Assinaturas</option>
                        <option value="Saúde">Saúde</option>
                        <option value="Moradia">Moradia</option>
                        <option value="Educação">Educação</option>
                        <option value="Vestuário">Vestuário</option>
                        <option value="Beleza">Beleza</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Banco/Cartão</label>
                    <input type="text" name="banco" required placeholder="Ex: Nubank"
                           class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="flex flex-col sm:flex-row gap-3 pt-2">
                    <button type="button" onclick="document.getElementById('modalAddGasto').classList.add('hidden')" 
                            class="w-full sm:flex-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2.5 rounded-lg font-medium transition text-sm sm:text-base">
                        Cancelar
                    </button>
                    <button type="submit" class="w-full sm:flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-4 py-2.5 rounded-lg font-medium transition text-sm sm:text-base">
                        Adicionar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Orçamento -->
    <div id="modalOrcamento" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl my-8">
            <div class="sticky top-0 bg-white dark:bg-gray-800 px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 dark:border-gray-700 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg sm:text-xl font-semibold text-gray-900 dark:text-white">Configurar Orçamento</h3>
                    <button onclick="document.getElementById('modalOrcamento').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <form method="POST" action="/configurar-meta" class="p-4 sm:p-6 space-y-4 sm:space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Renda Mensal (R$)</label>
                        <input type="number" name="salario" step="0.01" value="{{ salario if salario > 0 else '' }}" placeholder="5.000,00"
                               class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               oninput="calcularRegra5030()">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Define o limite superior dos gráficos</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Limite de Gastos (R$)</label>
                        <input type="number" name="meta" step="0.01" value="{{ meta_mensal if meta_mensal > 0 else '' }}" placeholder="3.000,00"
                               class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Linha de alerta nos gráficos</p>
                    </div>
                </div>
                
                <!-- Regra 50-30-20 -->
                <div id="regra5030" class="bg-white dark:bg-gray-800 rounded-xl p-4 sm:p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-0 mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center shadow-sm">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                </svg>
                            </div>
                            <h4 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white">Sugestão de Orçamento</h4>
                        </div>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <button type="button" onclick="toggleModo('padrao')" id="btnPadrao" class="flex-1 sm:flex-none px-3 py-1.5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg text-xs sm:text-sm font-medium transition shadow-sm hover:shadow-md">
                                50-30-20
                            </button>
                            <button type="button" onclick="toggleModo('customizado')" id="btnCustomizado" class="flex-1 sm:flex-none px-3 py-1.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg text-xs sm:text-sm font-medium transition hover:bg-gray-200 dark:hover:bg-gray-600">
                                Custom
                            </button>
                        </div>
                    </div>
                    
                    <!-- Modo Padrão -->
                    <div id="modoPadrao">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 mb-4">
                            <div class="bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/20 dark:to-green-900/20 rounded-lg p-3 sm:p-4 border border-emerald-200 dark:border-emerald-800">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-3 h-3 bg-emerald-500 rounded-full shadow-sm"></div>
                                    <h5 class="text-xs sm:text-sm font-semibold text-emerald-900 dark:text-emerald-100">50% Essenciais</h5>
                                </div>
                                <p class="text-xl sm:text-2xl font-bold text-emerald-700 dark:text-emerald-400" id="essenciais">R$ {{ (salario * 0.5) | moeda if salario > 0 else '0,00' }}</p>
                                <p class="text-[10px] sm:text-xs text-emerald-600 dark:text-emerald-500 mt-1">Moradia, alimentação, contas</p>
                            </div>
                            <div class="bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 rounded-lg p-3 sm:p-4 border border-amber-200 dark:border-amber-800">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-3 h-3 bg-amber-500 rounded-full shadow-sm"></div>
                                    <h5 class="text-xs sm:text-sm font-semibold text-amber-900 dark:text-amber-100">30% Desejos</h5>
                                </div>
                                <p class="text-xl sm:text-2xl font-bold text-amber-700 dark:text-amber-400" id="desejos">R$ {{ (salario * 0.3) | moeda if salario > 0 else '0,00' }}</p>
                                <p class="text-[10px] sm:text-xs text-amber-600 dark:text-amber-500 mt-1">Lazer, restaurantes</p>
                            </div>
                            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg p-3 sm:p-4 border border-blue-200 dark:border-blue-800">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-3 h-3 bg-blue-500 rounded-full shadow-sm"></div>
                                    <h5 class="text-xs sm:text-sm font-semibold text-blue-900 dark:text-blue-100">20% Poupança</h5>
                                </div>
                                <p class="text-xl sm:text-2xl font-bold text-blue-700 dark:text-blue-400" id="poupanca">R$ {{ (salario * 0.2) | moeda if salario > 0 else '0,00' }}</p>
                                <p class="text-[10px] sm:text-xs text-blue-600 dark:text-blue-500 mt-1">Investimentos, reserva</p>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button type="button" onclick="aplicarSugestao('essenciais')" 
                                    class="w-full sm:flex-1 px-3 py-2 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 rounded-lg text-xs sm:text-sm font-medium hover:bg-emerald-200 dark:hover:bg-emerald-900/50 transition border border-emerald-200 dark:border-emerald-800">
                                Usar 50% como limite
                            </button>
                            <button type="button" onclick="aplicarSugestao('gastos')" 
                                    class="w-full sm:flex-1 px-3 py-2 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 rounded-lg text-xs sm:text-sm font-medium hover:bg-amber-200 dark:hover:bg-amber-900/50 transition border border-amber-200 dark:border-amber-800">
                                Usar 80% como limite
                            </button>
                        </div>
                    </div>
                    
                    <!-- Modo Customizado -->
                    <div id="modoCustomizado" class="hidden">
                        <div class="bg-gradient-to-r from-yellow-50 to-amber-50 dark:from-yellow-900/20 dark:to-amber-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3 sm:p-4 mb-4">
                            <h5 class="text-xs sm:text-sm font-semibold text-yellow-900 dark:text-yellow-200 mb-1">Para quem mora com família</h5>
                            <p class="text-[10px] sm:text-xs text-yellow-800 dark:text-yellow-300">Recomendação: 20-30% gastos, 70-80% investimentos</p>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 mb-4">
                            <div class="bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/20 dark:to-green-900/20 rounded-lg p-3 sm:p-4 border border-emerald-200 dark:border-emerald-800">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-3 h-3 bg-emerald-500 rounded-full shadow-sm"></div>
                                    <h5 class="text-xs sm:text-sm font-semibold text-emerald-900 dark:text-emerald-100">Gastos</h5>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="range" id="percGastos" min="10" max="60" value="25" 
                                           class="flex-1 h-2 accent-emerald-500" oninput="atualizarCustomizado()">
                                    <span id="percGastosLabel" class="text-xs sm:text-sm font-medium text-emerald-900 dark:text-emerald-100 w-10">25%</span>
                                </div>
                                <p class="text-xl sm:text-2xl font-bold text-emerald-700 dark:text-emerald-400 mt-2" id="valorGastos">R$ 0,00</p>
                            </div>
                            
                            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg p-3 sm:p-4 border border-blue-200 dark:border-blue-800">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-3 h-3 bg-blue-500 rounded-full shadow-sm"></div>
                                    <h5 class="text-xs sm:text-sm font-semibold text-blue-900 dark:text-blue-100">Investir</h5>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="range" id="percInvest" min="30" max="80" value="60" 
                                           class="flex-1 h-2 accent-blue-500" oninput="atualizarCustomizado()">
                                    <span id="percInvestLabel" class="text-xs sm:text-sm font-medium text-blue-900 dark:text-blue-100 w-10">60%</span>
                                </div>
                                <p class="text-xl sm:text-2xl font-bold text-blue-700 dark:text-blue-400 mt-2" id="valorInvest">R$ 0,00</p>
                            </div>
                            
                            <div class="bg-gradient-to-br from-purple-50 to-violet-50 dark:from-purple-900/20 dark:to-violet-900/20 rounded-lg p-3 sm:p-4 border border-purple-200 dark:border-purple-800">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-3 h-3 bg-purple-500 rounded-full shadow-sm"></div>
                                    <h5 class="text-xs sm:text-sm font-semibold text-purple-900 dark:text-purple-100">Reserva</h5>
                                </div>
                                <p class="text-xl sm:text-2xl font-bold text-purple-700 dark:text-purple-400 mt-2" id="valorReserva">R$ 0,00</p>
                                <p class="text-[10px] sm:text-xs text-purple-600 dark:text-purple-500 mt-1">Sobra automática</p>
                            </div>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button type="button" onclick="aplicarCustomizado('gastos')" 
                                    class="w-full sm:flex-1 px-3 py-2 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 rounded-lg text-xs sm:text-sm font-medium hover:bg-emerald-200 dark:hover:bg-emerald-900/50 transition border border-emerald-200 dark:border-emerald-800">
                                Usar % gastos
                            </button>
                            <button type="button" onclick="aplicarCustomizado('total')" 
                                    class="w-full sm:flex-1 px-3 py-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg text-xs sm:text-sm font-medium hover:bg-blue-200 dark:hover:bg-blue-900/50 transition border border-blue-200 dark:border-blue-800">
                                Usar gastos + investir
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3">
                    <button type="button" onclick="document.getElementById('modalOrcamento').classList.add('hidden')" 
                            class="w-full sm:flex-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2.5 rounded-lg font-medium transition text-sm sm:text-base">
                        Cancelar
                    </button>
                    <button type="submit" class="w-full sm:flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-4 py-2.5 rounded-lg font-medium transition text-sm sm:text-base">
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ciclo -->
    <div id="modalCiclo" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
            <div class="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg sm:text-xl font-semibold text-gray-900 dark:text-white">Ciclo de Fatura</h3>
                    <button onclick="document.getElementById('modalCiclo').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <form method="POST" action="/configurar-fatura" class="p-4 sm:p-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Dia de Fechamento</label>
                <input type="number" name="dia" min="1" max="31" value="{{ dia_fechamento }}" 
                       class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Define quando o mês de referência muda</p>
                <div class="flex flex-col sm:flex-row gap-3 mt-6">
                    <button type="button" onclick="document.getElementById('modalCiclo').classList.add('hidden')" 
                            class="w-full sm:flex-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2.5 rounded-lg font-medium transition text-sm sm:text-base">
                        Cancelar
                    </button>
                    <button type="submit" class="w-full sm:flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-4 py-2.5 rounded-lg font-medium transition text-sm sm:text-base">
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Editar Gasto -->
    <div id="modalEditarGasto" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white dark:bg-gray-800 px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg sm:text-xl font-semibold text-gray-900 dark:text-white">Editar Gasto</h3>
                    <button onclick="document.getElementById('modalEditarGasto').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <form method="POST" action="/editar-gasto" class="p-4 sm:p-6 space-y-4">
                <input type="hidden" name="gasto_id" id="editGastoId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data do Gasto</label>
                    <input type="date" name="data_gasto" id="editDataGasto" required 
                           class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Valor (R$)</label>
                    <input type="number" name="valor" id="editValor" step="0.01" required placeholder="0.00"
                           class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Estabelecimento</label>
                    <input type="text" name="estabelecimento" id="editEstabelecimento" required placeholder="Ex: Supermercado"
                           class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Categoria</label>
                    <select name="categoria" id="editCategoria" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="Alimentação">Alimentação</option>
                        <option value="Transporte">Transporte</option>
                        <option value="Lazer/Assinaturas">Lazer/Assinaturas</option>
                        <option value="Saúde">Saúde</option>
                        <option value="Moradia">Moradia</option>
                        <option value="Educação">Educação</option>
                        <option value="Vestuário">Vestuário</option>
                        <option value="Beleza">Beleza</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div class="flex flex-col sm:flex-row gap-3 pt-2">
                    <button type="button" onclick="document.getElementById('modalEditarGasto').classList.add('hidden')" 
                            class="w-full sm:flex-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2.5 rounded-lg font-medium transition text-sm sm:text-base">
                        Cancelar
                    </button>
                    <button type="submit" class="w-full sm:flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white px-4 py-2.5 rounded-lg font-medium transition text-sm sm:text-base">
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Perfil -->
    <div id="modalPerfil" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-8 rounded-t-xl">
                <div class="flex flex-col items-center">
                    <div class="w-20 h-20 bg-white/20 backdrop-blur rounded-full flex items-center justify-center mb-3">
                        <span class="text-white text-3xl font-bold">{{ usuario.nome[0].upper() }}</span>
                    </div>
                    <h3 class="text-xl font-semibold text-white">{{ usuario.nome }}</h3>
                    <p class="text-sm text-indigo-100">{{ usuario.email }}</p>
                </div>
            </div>
            <div class="p-6 space-y-3">
                <button onclick="document.getElementById('modalPerfil').classList.add('hidden'); document.getElementById('modalTrocarSenha').classList.remove('hidden');" 
                        class="w-full flex items-center gap-3 px-4 py-3 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition">
                    <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                    </svg>
                    <span class="text-gray-900 dark:text-white font-medium">Trocar Senha</span>
                </button>
                <a href="/logout" class="w-full flex items-center gap-3 px-4 py-3 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition">
                    <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    <span class="text-red-600 dark:text-red-400 font-medium">Sair da Conta</span>
                </a>
                <button onclick="document.getElementById('modalPerfil').classList.add('hidden')" 
                        class="w-full px-4 py-2.5 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 font-medium transition">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Trocar Senha -->
    <div id="modalTrocarSenha" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Trocar Senha</h3>
                    <button onclick="document.getElementById('modalTrocarSenha').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <form method="POST" action="/trocar-senha" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Senha Atual</label>
                    <input type="password" name="senha_atual" required 
                           class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nova Senha</label>
                    <input type="password" name="senha_nova" required minlength="6"
                           class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Confirmar Nova Senha</label>
                    <input type="password" name="senha_confirma" required minlength="6"
                           class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <div class="flex flex-col sm:flex-row gap-3 pt-2">
                    <button type="button" onclick="document.getElementById('modalTrocarSenha').classList.add('hidden')" 
                            class="w-full sm:flex-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2.5 rounded-lg font-medium transition">
                        Cancelar
                    </button>
                    <button type="submit" class="w-full sm:flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-4 py-2.5 rounded-lg font-medium transition">
                        Alterar Senha
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Importar Extrato -->
    <div id="modalImportarExtrato" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl my-8">
            <div class="sticky top-0 bg-white dark:bg-gray-800 px-6 py-4 border-b border-gray-200 dark:border-gray-700 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Importar Extrato Bancário</h3>
                    <button onclick="fecharModalImportar()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div id="uploadArea" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center">
                    <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    <p class="text-gray-600 dark:text-gray-400 mb-2">Arraste seu extrato CSV ou clique para selecionar</p>
                    <input type="file" id="arquivoExtrato" accept=".csv" class="hidden" onchange="processarExtrato()">
                    <button onclick="document.getElementById('arquivoExtrato').click()" 
                            class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition">
                        Selecionar Arquivo
                    </button>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-4">Formato: CSV com colunas Data, Valor e Descrição</p>
                </div>
                
                <div id="previewArea" class="hidden mt-6">
                    <div id="alertaBaixaConfianca" class="hidden mb-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                            </svg>
                            <div>
                                <p class="font-medium text-yellow-800 dark:text-yellow-200"><span>0</span> itens precisam de revisão</p>
                                <p class="text-sm text-yellow-700 dark:text-yellow-300">Itens destacados em amarelo não foram categorizados automaticamente. Revise antes de importar.</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Revisão dos Gastos (<span id="totalGastos">0</span>)</h4>
                        <div>
                            <label class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Banco/Cartão:</label>
                            <input type="text" id="bancoImportacao" placeholder="Ex: Nubank" 
                                   class="border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg px-3 py-1.5 text-sm">
                        </div>
                    </div>
                    <div class="max-h-96 overflow-y-auto border border-gray-200 dark:border-gray-700 rounded-lg">
                        <table class="w-full">
                            <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0">
                                <tr class="text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">
                                    <th class="px-4 py-3 text-left">Data</th>
                                    <th class="px-4 py-3 text-left">Estabelecimento</th>
                                    <th class="px-4 py-3 text-left">Categoria</th>
                                    <th class="px-4 py-3 text-right">Valor</th>
                                    <th class="px-4 py-3 text-center">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaPreview" class="divide-y divide-gray-100 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="fecharModalImportar()" 
                                class="flex-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2.5 rounded-lg font-medium transition">
                            Cancelar
                        </button>
                        <button onclick="confirmarImportacao()" 
                                class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white px-4 py-2.5 rounded-lg font-medium transition">
                            Importar <span id="totalGastos2">0</span> Gastos
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Regras de Categorização -->
    <div id="modalRegras" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl my-8">
            <div class="sticky top-0 bg-white dark:bg-gray-800 px-6 py-4 border-b border-gray-200 dark:border-gray-700 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Regras de Categorização</h3>
                    <button onclick="document.getElementById('modalRegras').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-sm text-gray-600 dark:text-gray-400">Adicione palavras-chave para categorizar automaticamente seus gastos ao importar extratos.</p>
                <div id="regrasContainer" class="space-y-3">
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="document.getElementById('modalRegras').classList.add('hidden')" 
                            class="flex-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2.5 rounded-lg font-medium transition">
                        Cancelar
                    </button>
                    <button onclick="salvarRegras()" 
                            class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-4 py-2.5 rounded-lg font-medium transition">
                        Salvar Regras
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Registra Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registrado'))
                    .catch(err => console.log('Erro ao registrar Service Worker', err));
            });
        }
        
        // Inclui funções de correção de tema
        {% include 'chart-theme-fix.js' %}
        
        // Função para toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }
        
        // Função para alternar tema
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            const newTheme = isDark ? 'light' : 'dark';
            
            html.classList.toggle('dark');
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButton(newTheme);
            
            // Atualiza gráficos imediatamente
            if (typeof chartInstance !== 'undefined' && chartInstance) {
                atualizarGrafico(chartInstance.data.labels, chartInstance.data.datasets[0].data);
            }
            if (typeof pizzaChart !== 'undefined' && pizzaChart) {
                const isDarkNow = newTheme === 'dark';
                pizzaChart.data.datasets[0].backgroundColor = isDarkNow ? 
                    ['#60A5FA', '#FBBF24', '#34D399', '#F87171', '#A78BFA', '#F472B6', '#2DD4BF', '#FB923C'] :
                    ['#3B82F6', '#FBBF24', '#10B981', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'];
                pizzaChart.data.datasets[0].borderColor = isDarkNow ? '#1F2937' : '#fff';
                pizzaChart.options.plugins.legend.labels.color = isDarkNow ? '#D1D5DB' : '#374151';
                pizzaChart.options.plugins.tooltip.backgroundColor = isDarkNow ? '#1F2937' : '#FFFFFF';
                pizzaChart.options.plugins.tooltip.titleColor = isDarkNow ? '#F9FAFB' : '#111827';
                pizzaChart.options.plugins.tooltip.bodyColor = isDarkNow ? '#D1D5DB' : '#374151';
                pizzaChart.options.plugins.tooltip.borderColor = isDarkNow ? '#374151' : '#E5E7EB';
                pizzaChart.update();
            }
        }
        
        // Função para trocar idioma preservando mês e tema
        function changeLanguage(lang) {
            const urlParams = new URLSearchParams(window.location.search);
            const mes = urlParams.get('mes');
            const currentTheme = localStorage.getItem('theme') || 'light';
            
            // Salva tema antes de trocar idioma
            localStorage.setItem('theme', currentTheme);
            sessionStorage.setItem('preserveTheme', currentTheme);
            
            window.location.href = `/set-language/${lang}${mes ? '?mes=' + mes : ''}`;
        }
        
        function updateThemeButton(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            const isDark = theme === 'dark';
            
            if (isDark) {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>';
                text.textContent = '{{ t.get("light_mode", "Modo Claro") }}';
            } else {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>';
                text.textContent = '{{ t.get("dark_mode", "Modo Escuro") }}';
            }
        }
        
        // Atualiza ícone e texto do tema ao carregar
        document.addEventListener('DOMContentLoaded', function() {
            // Remove animações AOS para carregamento mais rápido
            document.querySelectorAll('[data-aos]').forEach(el => {
                el.removeAttribute('data-aos');
                el.removeAttribute('data-aos-delay');
            });
            
            // Restaura tema preservado após troca de idioma
            const preservedTheme = sessionStorage.getItem('preserveTheme');
            if (preservedTheme) {
                localStorage.setItem('theme', preservedTheme);
                document.documentElement.classList.toggle('dark', preservedTheme === 'dark');
                document.documentElement.setAttribute('data-theme', preservedTheme);
                sessionStorage.removeItem('preserveTheme');
            }
            
            // Atualiza botão de tema
            const currentTheme = localStorage.getItem('theme') || 'light';
            updateThemeButton(currentTheme);
            
            // Define data atual como padrão no modal de adicionar gasto
            const dataInput = document.querySelector('input[name="data_gasto"]');
            if (dataInput) {
                const hoje = new Date();
                const dataFormatada = hoje.toISOString().split('T')[0];
                dataInput.value = dataFormatada;
            }
            
            // Força atualização do layout após carregamento
            setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
            }, 100);
        });
        
        // Funções da Regra 50-30-20
        function calcularRegra5030() {
            const salarioInput = document.querySelector('input[name="salario"]');
            const regra5030Div = document.getElementById('regra5030');
            
            if (salarioInput.value && parseFloat(salarioInput.value) > 0) {
                const salario = parseFloat(salarioInput.value);
                
                const essenciais = salario * 0.5;
                const desejos = salario * 0.3;
                const poupanca = salario * 0.2;
                
                document.getElementById('essenciais').textContent = 'R$ ' + essenciais.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                document.getElementById('desejos').textContent = 'R$ ' + desejos.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                document.getElementById('poupanca').textContent = 'R$ ' + poupanca.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                
                // Atualiza modo customizado também
                atualizarCustomizado();
                
                regra5030Div.classList.remove('hidden');
            } else {
                regra5030Div.classList.add('hidden');
            }
        }
        
        function toggleModo(modo) {
            const btnPadrao = document.getElementById('btnPadrao');
            const btnCustomizado = document.getElementById('btnCustomizado');
            const modoPadrao = document.getElementById('modoPadrao');
            const modoCustomizado = document.getElementById('modoCustomizado');
            
            if (modo === 'padrao') {
                btnPadrao.className = 'flex-1 sm:flex-none px-3 py-1.5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg text-xs sm:text-sm font-medium transition shadow-sm hover:shadow-md';
                btnCustomizado.className = 'flex-1 sm:flex-none px-3 py-1.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg text-xs sm:text-sm font-medium transition hover:bg-gray-200 dark:hover:bg-gray-600';
                modoPadrao.classList.remove('hidden');
                modoCustomizado.classList.add('hidden');
            } else {
                btnPadrao.className = 'flex-1 sm:flex-none px-3 py-1.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg text-xs sm:text-sm font-medium transition hover:bg-gray-200 dark:hover:bg-gray-600';
                btnCustomizado.className = 'flex-1 sm:flex-none px-3 py-1.5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg text-xs sm:text-sm font-medium transition shadow-sm hover:shadow-md';
                modoPadrao.classList.add('hidden');
                modoCustomizado.classList.remove('hidden');
                atualizarCustomizado();
            }
        }
        
        function atualizarCustomizado() {
            const salarioInput = document.querySelector('input[name="salario"]');
            if (!salarioInput.value || parseFloat(salarioInput.value) <= 0) return;
            
            const salario = parseFloat(salarioInput.value);
            const percGastos = parseInt(document.getElementById('percGastos').value);
            const percInvest = parseInt(document.getElementById('percInvest').value);
            
            // Ajusta automaticamente para somar 100%
            const percReserva = 100 - percGastos - percInvest;
            
            const valorGastos = salario * (percGastos / 100);
            const valorInvest = salario * (percInvest / 100);
            const valorReserva = salario * (percReserva / 100);
            
            document.getElementById('percGastosLabel').textContent = percGastos + '%';
            document.getElementById('percInvestLabel').textContent = percInvest + '%';
            
            document.getElementById('valorGastos').textContent = 'R$ ' + valorGastos.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('valorInvest').textContent = 'R$ ' + valorInvest.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('valorReserva').textContent = 'R$ ' + valorReserva.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        }
        
        function aplicarCustomizado(tipo) {
            const salarioInput = document.querySelector('input[name="salario"]');
            const metaInput = document.querySelector('input[name="meta"]');
            
            if (salarioInput.value && parseFloat(salarioInput.value) > 0) {
                const salario = parseFloat(salarioInput.value);
                const percGastos = parseInt(document.getElementById('percGastos').value);
                const percInvest = parseInt(document.getElementById('percInvest').value);
                
                if (tipo === 'gastos') {
                    // Aplica apenas % de gastos como limite
                    metaInput.value = (salario * (percGastos / 100)).toFixed(2);
                } else if (tipo === 'total') {
                    // Aplica gastos + investimentos como limite
                    metaInput.value = (salario * ((percGastos + percInvest) / 100)).toFixed(2);
                }
            }
        }
        
        // Funções de edição de gastos
        function editarGasto(id, estabelecimento, categoria, valor, data) {
            document.getElementById('editGastoId').value = id;
            document.getElementById('editEstabelecimento').value = estabelecimento;
            document.getElementById('editCategoria').value = categoria;
            document.getElementById('editValor').value = valor;
            document.getElementById('editDataGasto').value = data;
            document.getElementById('modalEditarGasto').classList.remove('hidden');
        }
        
        function excluirGasto(id) {
            if (confirm('Tem certeza que deseja excluir este gasto?')) {
                fetch('/excluir-gasto', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'gasto_id=' + id
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Erro ao excluir gasto');
                    }
                })
                .catch(error => {
                    alert('Erro ao excluir gasto');
                });
            }
        }
        
        function aplicarSugestao(tipo) {
            const salarioInput = document.querySelector('input[name="salario"]');
            const metaInput = document.querySelector('input[name="meta"]');
            
            if (salarioInput.value && parseFloat(salarioInput.value) > 0) {
                const salario = parseFloat(salarioInput.value);
                
                if (tipo === 'essenciais') {
                    // Aplica 50% como limite de gastos
                    metaInput.value = (salario * 0.5).toFixed(2);
                } else if (tipo === 'gastos') {
                    // Aplica 80% como limite de gastos (50% essenciais + 30% desejos)
                    metaInput.value = (salario * 0.8).toFixed(2);
                }
            }
        }
        
        // Busca
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const search = e.target.value.toLowerCase();
            document.querySelectorAll('#extratoTable tbody tr').forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
            });
        });

        // Gráfico Evolução
        const metaMensal = {{ meta_mensal if meta_mensal > 0 else 0 }};
        const salario = {{ salario if salario > 0 else 0 }};
        const previsao = {{ previsao }};
        let gastosData = {{ evolucao_valores_json | safe }};
        let labels = {{ evolucao_labels_json | safe }};
        
        // Armazena dados completos
        const dadosCompletos = {
            labels: [...labels],
            gastos: [...gastosData]
        };
        
        // Se não houver dados suficientes, adiciona meses anteriores para visualização
        if (labels.length < 6) {
            const mesesFaltantes = 6 - labels.length;
            const hoje = new Date();
            for (let i = mesesFaltantes; i > 0; i--) {
                const data = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                const mesAno = data.getFullYear() + '-' + String(data.getMonth() + 1).padStart(2, '0');
                labels.unshift(mesAno);
                gastosData.unshift(0);
            }
            dadosCompletos.labels = [...labels];
            dadosCompletos.gastos = [...gastosData];
        }
        
        let chartInstance = null;
        
        function filtrarPeriodo(meses) {
            const numMeses = parseInt(meses);
            const labelsFiltered = dadosCompletos.labels.slice(-numMeses);
            const gastosFiltered = dadosCompletos.gastos.slice(-numMeses);
            
            atualizarGrafico(labelsFiltered, gastosFiltered);
        }
        
        function atualizarGrafico(labelsData, gastosDataArray) {
            const maxGasto = gastosDataArray.length > 0 ? Math.max(...gastosDataArray) : 0;
            const isDark = document.documentElement.classList.contains('dark');
            
            let yMax;
            if (salario > 0) {
                yMax = salario;
            } else {
                yMax = Math.max(metaMensal, maxGasto, previsao) * 1.15;
                if (yMax < 1000) yMax = 1000;
            }
            
            const datasets = [{
                label: 'Gastos',
                data: gastosDataArray,
                backgroundColor: isDark ? '#34D399' : '#10B981',
                borderRadius: 6,
                barThickness: 40
            }];
            
            if (metaMensal > 0) {
                datasets.push({
                    label: 'Meta de Gastos',
                    data: Array(labelsData.length).fill(metaMensal),
                    borderColor: isDark ? '#F87171' : '#EF4444',
                    borderWidth: 3,
                    type: 'line',
                    fill: false
                });
            }
            
            if (previsao > 0) {
                datasets.push({
                    label: 'Previsão (Média)',
                    data: Array(labelsData.length).fill(previsao),
                    borderColor: isDark ? '#FCD34D' : '#FBBF24',
                    borderWidth: 2,
                    borderDash: [4, 4],
                    type: 'line',
                    fill: false,
                    pointRadius: 0,
                    tension: 0
                });
            }
            
            if (chartInstance) {
                chartInstance.data.labels = labelsData;
                chartInstance.data.datasets = datasets;
                chartInstance.options.scales.y.max = yMax;
                chartInstance.options.scales.y.ticks.color = isDark ? '#D1D5DB' : '#6B7280';
                chartInstance.options.scales.x.ticks.color = isDark ? '#D1D5DB' : '#6B7280';
                chartInstance.options.scales.y.grid.color = isDark ? 'rgba(75, 85, 99, 0.3)' : 'rgba(0,0,0,0.05)';
                chartInstance.options.plugins.legend.labels.color = isDark ? '#D1D5DB' : '#374151';
                chartInstance.update();
            } else {
                chartInstance = new Chart(document.getElementById('evolucaoChart'), {
                    type: 'bar',
                    data: {
                        labels: labelsData,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                display: true, 
                                position: 'top',
                                labels: { 
                                    padding: 15, 
                                    usePointStyle: true,
                                    color: isDark ? '#D1D5DB' : '#374151'
                                }
                            },
                            tooltip: {
                                backgroundColor: isDark ? '#1F2937' : '#FFFFFF',
                                titleColor: isDark ? '#F9FAFB' : '#111827',
                                bodyColor: isDark ? '#D1D5DB' : '#374151',
                                borderColor: isDark ? '#374151' : '#E5E7EB',
                                borderWidth: 1,
                                callbacks: {
                                    footer: function(context) {
                                        if (salario > 0) {
                                            return 'Salário: R$ ' + salario.toLocaleString('pt-BR');
                                        }
                                        return '';
                                    }
                                }
                            }
                        },
                        scales: { 
                            y: { 
                                beginAtZero: true,
                                max: yMax,
                                ticks: { 
                                    callback: v => 'R$ ' + v.toLocaleString('pt-BR', {minimumFractionDigits: 0}),
                                    color: isDark ? '#D1D5DB' : '#6B7280'
                                },
                                grid: { color: isDark ? 'rgba(75, 85, 99, 0.3)' : 'rgba(0,0,0,0.05)' }
                            },
                            x: { 
                                grid: { display: false },
                                ticks: { color: isDark ? '#D1D5DB' : '#6B7280' }
                            }
                        }
                    }
                });
            }
        }
        
        // Inicializa com 12 meses
        atualizarGrafico(labels, gastosData);

        // Gráfico Pizza
        let isDark = document.documentElement.classList.contains('dark');
        let pizzaChart = new Chart(document.getElementById('gastosChart'), {
            type: 'doughnut',
            data: {
                labels: {{ chart_labels_json | safe }},
                datasets: [{
                    data: {{ chart_data_json | safe }},
                    backgroundColor: isDark ? 
                        ['#60A5FA', '#FBBF24', '#34D399', '#F87171', '#A78BFA', '#F472B6', '#2DD4BF', '#FB923C'] :
                        ['#3B82F6', '#FBBF24', '#10B981', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'],
                    borderWidth: 2,
                    borderColor: isDark ? '#1F2937' : '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        position: 'bottom', 
                        labels: { 
                            usePointStyle: true, 
                            padding: 15,
                            font: { size: 11 },
                            color: isDark ? '#D1D5DB' : '#374151'
                        } 
                    },
                    tooltip: {
                        backgroundColor: isDark ? '#1F2937' : '#FFFFFF',
                        titleColor: isDark ? '#F9FAFB' : '#111827',
                        bodyColor: isDark ? '#D1D5DB' : '#374151',
                        borderColor: isDark ? '#374151' : '#E5E7EB',
                        borderWidth: 1
                    }
                }
            }
        });
        
        // Funções de Importação de Extrato
        let gastosImportados = [];
        
        async function processarExtrato() {
            const arquivo = document.getElementById('arquivoExtrato').files[0];
            if (!arquivo) return;
            
            const formData = new FormData();
            formData.append('arquivo', arquivo);
            
            try {
                const response = await fetch('/importar-extrato', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                gastosImportados = data.gastos;
                
                if (gastosImportados.length === 0) {
                    alert('Nenhum gasto encontrado no arquivo. Verifique o formato.');
                    return;
                }
                
                exibirPreview();
            } catch (error) {
                alert('Erro ao processar arquivo: ' + error.message);
            }
        }
        
        function exibirPreview() {
            document.getElementById('uploadArea').classList.add('hidden');
            document.getElementById('previewArea').classList.remove('hidden');
            
            const tbody = document.getElementById('tabelaPreview');
            tbody.innerHTML = '';
            
            let baixaConfianca = 0;
            
            gastosImportados.forEach((gasto, index) => {
                const confianca = gasto.confianca || 0;
                const precisaRevisao = confianca < 0.5;
                if (precisaRevisao) baixaConfianca++;
                
                const tr = document.createElement('tr');
                tr.className = `hover:bg-gray-50 dark:hover:bg-gray-700 ${precisaRevisao ? 'bg-yellow-50 dark:bg-yellow-900/20' : ''}`;
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-300">${new Date(gasto.data).toLocaleDateString('pt-BR')}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 dark:text-white">
                        <input type="text" value="${gasto.estabelecimento}" 
                               onchange="gastosImportados[${index}].estabelecimento = this.value"
                               class="w-full bg-transparent border-0 focus:ring-1 focus:ring-indigo-500 rounded px-2 py-1">
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-2">
                            <select onchange="gastosImportados[${index}].categoria = this.value" 
                                    class="text-xs ${precisaRevisao ? 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 ring-2 ring-yellow-400' : 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200'} rounded px-2 py-1 border-0">
                                <option value="Alimentação" ${gasto.categoria === 'Alimentação' ? 'selected' : ''}>Alimentação</option>
                                <option value="Transporte" ${gasto.categoria === 'Transporte' ? 'selected' : ''}>Transporte</option>
                                <option value="Lazer/Assinaturas" ${gasto.categoria === 'Lazer/Assinaturas' ? 'selected' : ''}>Lazer/Assinaturas</option>
                                <option value="Saúde" ${gasto.categoria === 'Saúde' ? 'selected' : ''}>Saúde</option>
                                <option value="Moradia" ${gasto.categoria === 'Moradia' ? 'selected' : ''}>Moradia</option>
                                <option value="Educação" ${gasto.categoria === 'Educação' ? 'selected' : ''}>Educação</option>
                                <option value="Vestuário" ${gasto.categoria === 'Vestuário' ? 'selected' : ''}>Vestuário</option>
                                <option value="Beleza" ${gasto.categoria === 'Beleza' ? 'selected' : ''}>Beleza</option>
                                <option value="Outros" ${gasto.categoria === 'Outros' ? 'selected' : ''}>Outros</option>
                            </select>
                            ${precisaRevisao ? '<span class="text-xs text-yellow-600 dark:text-yellow-400" title="Requer revisão">⚠️</span>' : ''}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm font-semibold text-gray-900 dark:text-white text-right">
                        <input type="number" step="0.01" value="${gasto.valor.toFixed(2)}" 
                               onchange="gastosImportados[${index}].valor = parseFloat(this.value)"
                               class="w-24 text-right bg-transparent border-0 focus:ring-1 focus:ring-indigo-500 rounded px-2 py-1">
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="removerGasto(${index})" class="text-red-600 hover:text-red-800">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('totalGastos').textContent = gastosImportados.length;
            document.getElementById('totalGastos2').textContent = gastosImportados.length;
            
            // Mostra alerta se houver itens com baixa confiança
            const alertaDiv = document.getElementById('alertaBaixaConfianca');
            if (baixaConfianca > 0) {
                alertaDiv.classList.remove('hidden');
                alertaDiv.querySelector('span').textContent = baixaConfianca;
            } else {
                alertaDiv.classList.add('hidden');
            }
        }
        
        function removerGasto(index) {
            gastosImportados.splice(index, 1);
            exibirPreview();
        }
        
        async function confirmarImportacao() {
            const banco = document.getElementById('bancoImportacao').value;
            if (!banco) {
                alert('Por favor, informe o banco/cartão');
                return;
            }
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/confirmar-importacao';
            
            const inputGastos = document.createElement('input');
            inputGastos.type = 'hidden';
            inputGastos.name = 'gastos_json';
            inputGastos.value = JSON.stringify(gastosImportados);
            
            const inputBanco = document.createElement('input');
            inputBanco.type = 'hidden';
            inputBanco.name = 'banco';
            inputBanco.value = banco;
            
            form.appendChild(inputGastos);
            form.appendChild(inputBanco);
            document.body.appendChild(form);
            form.submit();
        }
        
        function fecharModalImportar() {
            document.getElementById('modalImportarExtrato').classList.add('hidden');
            document.getElementById('uploadArea').classList.remove('hidden');
            document.getElementById('previewArea').classList.add('hidden');
            document.getElementById('arquivoExtrato').value = '';
            gastosImportados = [];
        }
        
        // Funções de Regras de Categorização
        async function carregarRegras() {
            try {
                const response = await fetch('/regras-categorizacao');
                const regras = await response.json();
                
                const container = document.getElementById('regrasContainer');
                container.innerHTML = '';
                
                // Garante que todas as categorias existam
                const categoriasPadrao = ['Alimentação', 'Transporte', 'Lazer/Assinaturas', 'Saúde', 'Moradia', 'Educação', 'Vestuário', 'Beleza'];
                
                for (const categoria of categoriasPadrao) {
                    const palavras = regras[categoria] || [];
                    const div = document.createElement('div');
                    div.className = 'bg-gray-50 dark:bg-gray-700 rounded-lg p-4';
                    div.innerHTML = `
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">${categoria}</label>
                        <input type="text" data-categoria="${categoria}" value="${palavras.join(', ')}" 
                               placeholder="Ex: ifood, restaurante, padaria"
                               class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Separe as palavras-chave por vírgula</p>
                    `;
                    container.appendChild(div);
                }
            } catch (error) {
                alert('Erro ao carregar regras: ' + error.message);
            }
        }
        
        async function salvarRegras() {
            const inputs = document.querySelectorAll('#regrasContainer input[data-categoria]');
            const regras = {};
            
            inputs.forEach(input => {
                const categoria = input.dataset.categoria;
                const palavras = input.value.split(',').map(p => p.trim()).filter(p => p);
                regras[categoria] = palavras;
            });
            
            try {
                const formData = new FormData();
                formData.append('regras_json', JSON.stringify(regras));
                
                await fetch('/salvar-regras-categorizacao', {
                    method: 'POST',
                    body: formData
                });
                
                document.getElementById('modalRegras').classList.add('hidden');
                alert('Regras salvas com sucesso!');
            } catch (error) {
                alert('Erro ao salvar regras: ' + error.message);
            }
        }
    </script>
</body>
</html>